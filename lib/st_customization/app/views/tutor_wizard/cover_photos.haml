// main block for all wizard steps
.page-content-inner.wizard.wizard-instructor
  .head-section
    %h1.head-section-title Cover Photos
  = render partial: 'wizard_head'
  .wizard-section
    %h2.small-title.flex-block 
      .title-image-holder
        = image_tag "custom_images/cover-photos.png"
      Choose your cover photos
    .wizard-content
      .errors
      .wizard-inner
        %p.mb-25 Help your students get a feel of who you are and what you can do. Upload up to 10 images that showcase your abilities, or your teaching style.
        .row
          .col-6
            = link_to '#', class: 'btn btn--black upload-link trigger_upload' do
              .small-icon
                %svg.svg-inline--fa.fa-file-upload.fa-w-12{"aria-hidden" => "true", "data-icon" => "file-upload", "data-prefix" => "fas", :focusable => "false", :role => "img", :viewbox => "0 0 384 512", :xmlns => "http://www.w3.org/2000/svg"}
                  %path{:d => "M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm65.18 216.01H224v80c0 8.84-7.16 16-16 16h-32c-8.84 0-16-7.16-16-16v-80H94.82c-14.28 0-21.41-17.29-11.27-27.36l96.42-95.7c6.65-6.61 17.39-6.61 24.04 0l96.42 95.7c10.15 10.07 3.03 27.36-11.25 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z", :fill => "currentColor"}
              Upload Files from computer
        .need-upload
          = form_for @custom_profile, url: profile_upload_cover_photos_path(@custom_profile), remote: true, html: { multipart: true, id: "fileupload" } do |f|
            - idx = 0
            = f.fields_for :cover_photos, @custom_profile.cover_photos.build do |photos_fields|
              = photos_fields.file_field :image, multiple: true, name: "custom_profile[cover_photos_attributes][#{idx}][image]" if photos_fields.object.new_record?
            .existing_cover_photos
              = f.fields_for :cover_photos, @custom_profile.cover_photos do |photos_fields|
                - unless photos_fields.object.new_record?
                  .fields_cont.existing_photo_record
                    .thumb-block
                      = image_tag photos_fields.object.image.url(:thumb)
                    %div.image_descr
                      %div= photos_fields.object.image.original_filename
                      = photos_fields.hidden_field :id
                      = photos_fields.label :_destroy, 'Remove this photo', class: 'remove-photo'
                      = photos_fields.check_box :_destroy, {class: 'delete_record_chbx'}
                      = photos_fields.check_box :is_primary_photo, {class: 'set_primary_record_chbx'}
                      .primary-holder
                        = photos_fields.label :is_primary_photo, 'Make primary photo', class: 'remove-photo make-primary'
                        .primary-photo Primary photo
          %table.table.table-striped.test-class-test
            %tbody.files{data: {toggle: "modal-gallery", target: "#modal-gallery"}}
          .row.step-buttons
            .col-6
              = link_to "Back", @prev_step_path, class: 'confirm_step_btn btn btn--violet-transp', remote: true
            .col-6
              = link_to "Next", @confirm_step_path, class: 'confirm_step_btn btn btn--violet', remote: true
              -# = link_to "Skip this step", tutor_wizard_skip_step_path(@tutor_status.signup_status), class: 'block skip-btn'

= render partial: 'view_tools/confirm_step_btn_js'

:javascript
  function build_photo_spots(items) {

    $('.existing_cover_photos').html('');

    items.forEach(function(item, i){
      idx = i + 1
      var img_cont = $('<div>', {class: 'image_spot'})

      var id_field = $('<input type="hidden">')
      $(id_field).attr('name', 'custom_profile[cover_photos_attributes][' + idx + '][id]')
      $(id_field).attr('id', 'custom_profile_cover_photos_attributes_' + idx + '_id')
      $(id_field).val(item.id)

      var destroy_field = $('<input type="checkbox">')
      $(destroy_field).attr('name', 'custom_profile[cover_photos_attributes][' + idx + '][_destroy]')
      $(destroy_field).attr('id', 'custom_profile_cover_photos_attributes_' + idx + '__destroy')
      //$(destroy_field).addClass('delete_record_chbx');
      $(destroy_field).val(1)
      $(destroy_field).on('click', function(){
        $('#fileupload').trigger('submit.rails');
      });

      var set_primary_field = $('<input type="checkbox">')
      $(set_primary_field).attr('name', 'custom_profile[cover_photos_attributes][' + idx + '][is_primary_photo]')
      $(set_primary_field).attr('id', 'custom_profile_cover_photos_attributes_' + idx + '_is_primary_photo')
      $(set_primary_field).addClass('set_primary_record_chbx');
      $(set_primary_field).val(1)
      $(set_primary_field).prop('checked', item.is_primary_photo);
      
      var set_primary_label;

      if(item.is_primary_photo === true) {
        set_primary_label = $('<div class="primary-photo">').html('Primary photo') 
      } else {
        set_primary_label = $('<label class="remove-photo" for="custom_profile_cover_photos_attributes_' + idx + '_is_primary_photo">').html('Make primary photo') 
      }

      var descr_cont = $('<div>', {class: 'image_descr'});
      var img_holder = $('<div>', {class: 'thumb-block'})
      var idField = id_field;
      var destroyBtn = $('<label class="remove-photo" for="custom_profile_cover_photos_attributes_' + idx + '__destroy">').html('Remove this photo')
      var destroyField = destroy_field;
      var imageTag = $('<img>',{src: item.url});
      var imageName = $('<div>').html(item.name);

      descr_cont.append(imageName, idField, destroyBtn, destroyField, set_primary_label, set_primary_field);
      img_holder.append(imageTag);
      img_cont.append(img_holder, descr_cont);

      $('.existing_cover_photos').append(img_cont);
      checkPhotosNumber('.fields_cont, .image_spot');

    })
  }

  onDocumentReady(function(){
    
    $('.trigger_upload').on('click', function(event) {
      event.preventDefault();
      $('input[type="file"]').trigger('click');
    });

    $('#fileupload').on('click', '.delete_record_chbx', function(){
      $('#fileupload').trigger('submit.rails');
    });

    $('#fileupload').on('click', '.set_primary_record_chbx', function(e){
      $('.set_primary_record_chbx:not(#' + e.target.id + ')').val(0);
      $('#fileupload').trigger('submit.rails');
    });

    $("#fileupload").on("ajax:success", function(event, data){
            build_photo_spots(data.images);
          }
        ).on("ajax:error", function(event, data){
            // console.log(data.responseJSON.error);
            console.log(data);
            $(".errors").html('Error:')
            var err_obj = data.responseJSON.error
            Object.keys(err_obj).forEach(function (key) { 
              var value = err_obj[key]
              $(".errors").append(key + ': ' + value[0]);
            })
          }
        )

    $('#fileupload').fileupload({
      done: function (e, data) {
          if (data.result.error === undefined) {
            build_photo_spots(data.result.images);
          } else {
            alert(data.result.error);
          }
        }
    });

    checkPhotosNumber('.fields_cont, .image_spot');
  });

