// main block for all wizard steps
.page-content-inner.wizard.wizard-instructor
  .head-section
    %h1.head-section-title Set up your profile
  = render partial: 'wizard_head'
  // awards and certifications
  .wizard-section
    %h2.small-title.flex-block
      .title-image-holder
        = image_tag "custom_images/medal.png"
      Awards, certification and other qualifications (optional)
    .wizard-content
      .awards-head.lined
        %p.mb-25 Are you certified to teach? Do you have certifications related to what you plan to teach, or have you compted in tournaments? Tell us and tell your students!
        %p
          If you have photo proof of your qualifications, you can get a 
          %span.verify-sign
            = image_tag "homepage/medal.png", class: 'small-icon'
            %span.uppercase.green Competitor
          Badge or a
          %span.verify-sign
            = image_tag "homepage/certificate.png", class: 'small-icon'
            %span.uppercase.green Certified instructor

      .wizard-inner
        .uploading-form
          = form_for @new_certification, remote: true, html: { multipart: true, id: 'new_certification_form' } do |f|
            .need-upload
              .errors
              .mb-50
                %p From the dropdown, choose the Category that best describes the Qualification that you have in mind.
                .row
                  .col-6
                    = f.select :category_id, categories_for_select, {}, { id: "category-select", class: 'custom-select', data: {:placeholder => 'Choose a Category for your Qualification'} }
              .row.mb-50
                .col-6
                  %p Describe your qualification.
                  = f.text_field :name, placeholder: 'The name of your Qualification', class: "input"
              %p Upload photo proof of your qualification. Please upload documentation of your qualification to qualify for a badge. Only Bizaar staff will see and have access this photo- it will not be viewable by other Instructors or Members.

              .upload-files-holder
                .row
                  .col-6
                    = label_tag :certification_image, class: 'btn btn--black upload-link' do
                      .small-icon
                        %svg.svg-inline--fa.fa-file-upload.fa-w-12{"aria-hidden" => "true", "data-icon" => "file-upload", "data-prefix" => "fas", :focusable => "false", :role => "img", :viewbox => "0 0 384 512", :xmlns => "http://www.w3.org/2000/svg"}
                          %path{:d => "M224 136V0H24C10.7 0 0 10.7 0 24v464c0 13.3 10.7 24 24 24h336c13.3 0 24-10.7 24-24V160H248c-13.2 0-24-10.8-24-24zm65.18 216.01H224v80c0 8.84-7.16 16-16 16h-32c-8.84 0-16-7.16-16-16v-80H94.82c-14.28 0-21.41-17.29-11.27-27.36l96.42-95.7c6.65-6.61 17.39-6.61 24.04 0l96.42 95.7c10.15 10.07 3.03 27.36-11.25 27.36zM377 105L279.1 7c-4.5-4.5-10.6-7-17-7H256v128h128v-6.1c0-6.3-2.5-12.4-7-16.9z", :fill => "currentColor"}
                      Upload Files from computer
                = f.file_field :image
                .uploaded-file-container
                  .pdfPreview.hidden-preview
                    = image_tag 'custom_images/pdf.png', class: 'image'
          .row
            .col-6
              = link_to '#', class: 'btn btn--green block submit_remote_form_btn get-badge' do
                .small-icon
                  %svg.svg-inline--fa.fa-graduation-cap.fa-w-20{"aria-hidden" => "true", "data-icon" => "graduation-cap", "data-prefix" => "fas", :focusable => "false", :role => "img", :viewbox => "0 0 640 512", :xmlns => "http://www.w3.org/2000/svg"}
                    %path{:d => "M622.34 153.2L343.4 67.5c-15.2-4.67-31.6-4.67-46.79 0L17.66 153.2c-23.54 7.23-23.54 38.36 0 45.59l48.63 14.94c-10.67 13.19-17.23 29.28-17.88 46.9C38.78 266.15 32 276.11 32 288c0 10.78 5.68 19.85 13.86 25.65L20.33 428.53C18.11 438.52 25.71 448 35.94 448h56.11c10.24 0 17.84-9.48 15.62-19.47L82.14 313.65C90.32 307.85 96 298.78 96 288c0-11.57-6.47-21.25-15.66-26.87.76-15.02 8.44-28.3 20.69-36.72L296.6 284.5c9.06 2.78 26.44 6.25 46.79 0l278.95-85.7c23.55-7.24 23.55-38.36 0-45.6zM352.79 315.09c-28.53 8.76-52.84 3.92-65.59 0l-145.02-44.55L128 384c0 35.35 85.96 64 192 64s192-28.65 192-64l-14.18-113.47-145.03 44.56z", :fill => "currentColor"}

                Get my badge!
            -# .col-6
            -#   = link_to "Skip this step", tutor_wizard_skip_step_path(@tutor_status.signup_status), class: 'btn btn--violet block'
        .after-uploading
          %h3.small-title.flex-block
            .title-image-holder
              %svg.svg-inline--fa.fa-check-circle.fa-w-16{"aria-hidden" => "true", "data-icon" => "check-circle", "data-prefix" => "far", :focusable => "false", :role => "img", :viewbox => "0 0 512 512", :xmlns => "http://www.w3.org/2000/svg"}
                %path{:d => "M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 48c110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200-110.532 0-200-89.451-200-200 0-110.532 89.451-200 200-200m140.204 130.267l-22.536-22.718c-4.667-4.705-12.265-4.736-16.97-.068L215.346 303.697l-59.792-60.277c-4.667-4.705-12.265-4.736-16.97-.069l-22.719 22.536c-4.705 4.667-4.736 12.265-.068 16.971l90.781 91.516c4.667 4.705 12.265 4.736 16.97.068l172.589-171.204c4.704-4.668 4.734-12.266.067-16.971z", :fill => "#fff"}

            %span Thank you for uploading your documents! We will review the documents, and notify you when itâ€™s approved.
        .added-certifications-holder
          %h3.section-subtitle Added Qualifications:
          .existing_certifications
            - @existing_certifications.each do |certification|
              .certificate-item
                .thumb-block
                  = image_tag certification.attachment_thumb_url, class: 'image'
                .certificate-description
                  .file-name.qualification-name
                    = certification.name
                  .file-name.category-name
                    = certification.category_name
                  = label :_destroy, 'Remove this photo', class: 'green link underline remove-photo'
                  = check_box :_destroy, '', class: 'remove-checkbox', data: {'cert_id' => certification.id}
          = link_to '+ Add another qualification', '#', class: 'underline uppercase add-another-qual'
        .row
          .col-6
            = link_to "Back", @prev_step_path, class: 'confirm_step_btn btn btn--violet-transp', remote: true
          .col-6
            = link_to "Next", @confirm_step_path, class: 'confirm_step_btn btn btn--violet next-btn', remote: true
            = link_to "Skip this step", tutor_wizard_skip_step_path(@tutor_status.signup_status), class: 'btn btn--violet block skip-qual-btn'
          -# = link_to "Skip current step", tutor_wizard_skip_step_path(@tutor_status.signup_status), class: ''

= render partial: 'confirm_step_btn_js'

:javascript
  onDocumentReady(function() {

    $('.existing_certifications').on('click', '.remove-photo', function(e){
      var cert_conainer = $(e.target).parent().parent()[0];
      var cert_id = $($(e.target).parent().children('input.remove-checkbox').first()[0]).data('certId')
      // console.log(cert_conainer)
  
      $.ajax({
          url: "#{certifications_path.split('?').first}" + "/" + cert_id + "",
          type: 'DELETE',
          success: function(data){            
            $(cert_conainer).remove();
            console.log($('.certificate-item').length);

            if($('.certificate-item').length === 0) {
              $('.added-certifications-holder').hide();
              $('.uploading-form').show();

              clearForm();
              
              $('.skip-qual-btn').css('display', 'block');
              $('.next-btn').hide();
            } 
          },
          error: function(data){
            $(".errors").append('<div class="error-item">Can\'t delete item (' + data.status + ')</div>');
          }
      });
    });

    var uploadedImageTemplate = '<div class="uploaded-file"><div class="thumb-block uploaded-thumb-block"></div><div class="file-action-block"><div class="name"></div><a href="#" class="green link underline remove-preview">Remove this photo</a></div></div>'

    document.getElementById('certification_image').addEventListener('change', function (e) {
      if('.uploaded-file') {
        $('.uploaded-file').remove();
      }
      var file = this.files[0];
      var reader = new FileReader();

      var extension = file.name.split('.').pop().toLowerCase();
      var pdfPreview = $('.pdfPreview');

      reader.onload = function(e) {
        var img = new Image();
        img.src = reader.result;

        
        $('.uploaded-file-container').append(uploadedImageTemplate)
        $('.uploaded-thumb-block').html(img);

        if(extension == 'pdf') {
          $('.uploaded-thumb-block').parents('div').find(pdfPreview).removeClass('hidden-preview');
        } else {
          $('.uploaded-thumb-block').parents('div').find(pdfPreview).addClass('hidden-preview');
        }

        $('.get-badge').css('display', 'flex');
      }
      
      reader.readAsDataURL(file);

    });
    
    $('.uploaded-file-container').on('click', '.remove-preview', function(event) {
      event.preventDefault();
      $('#certification_image').val('');
      $(this).parents('div').find('.uploaded-file').remove();
      $('.get-badge').hide();
    });

    $('.submit_remote_form_btn').on('click', function(event) {
      event.preventDefault();
      event.stopPropagation();

      $("#new_certification_form").trigger('submit')
    });
      
    $("#new_certification_form").on('submit', function(e) {
      e.preventDefault();
      var formData = new FormData(this);

      $.ajax({
        type: "POST",
        url: $(this).attr('action'),
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
          $('.after-uploading').show();
          $('.uploaded-file').hide();
          $('.existing_certifications').html('')
          data.existing_certifications.forEach(function(item, i) {
            var certificateItem = $('<div>', {class: 'certificate-item'});
            var imageHolder = $('<div>', {class: 'thumb-block'});
            var certificateDescription = $('<div>', {class: 'certificate-description'});

            var image = $('<img>',{src: item.image_thumb_url, alt: item.name});
            var qualification = $('<div class="qualification-name">' + item.name + '</div>');
            var category = $('<div class="category-name">' + item.category_name + '</div>')

            var destroyCheckbox = $('<input type="checkbox" class="remove-checkbox">');
            $(destroyCheckbox).data('certId', item.id);
            var destroyLabel = $('<label class="remove-photo" for="__destroy">').html('Remove this photo')
            
            certificateDescription.append(qualification, category, destroyLabel, destroyCheckbox);
            imageHolder.append(image);
            certificateItem.append(imageHolder, certificateDescription);

            $('.existing_certifications').append(certificateItem);

            $('.uploading-form').hide();
            clickOutside('.after-uploading');
            $('.added-certifications-holder').show();
          })
          $('.skip-qual-btn').hide();
          $('.next-btn').css('display', 'block');
        },
        error: function(error) {
          $(".errors").html('').fadeIn();
          var err_obj = error.responseJSON.error
          Object.keys(err_obj).forEach(function (key) { 
            var value = err_obj[key]
            $(".errors").append('<div class="error-item">' + key + ' ' + value[0] +'</div>');
          })

          clickOutside('.errors');
        }
      });
    });

    $('.add-another-qual').on('click', function(event) {
      event.preventDefault();
      $('.uploading-form').show();

      clearForm();
    });

    if ($('.certificate-item').length !== 0) {
      $('.added-certifications-holder').show();
      $('.skip-qual-btn').hide();
      $('.next-btn').css('display', 'block');
    } else {
      $('.added-certifications-holder').hide();
      $('.skip-qual-btn').css('display', 'block');
      $('.next-btn').hide();
    }

    function clearForm() {
      $('#certification_image').val('');
      $('#certification_name').val('');
      $('#category-select').val(null).trigger('change');
    }
  });

